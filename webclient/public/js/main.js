function MainCtrl($scope,ModuleService,HouseMapService){$scope.supervision={},$scope.supervision.module="",$scope.supervision.data={},$scope.supervision.maxData=10,$scope.supervision.poll=null,$scope.$watch("supervision.module",function(){$scope.supervision.poll&&($scope.supervision.poll.cancel(),$scope.supervision.data={}),$scope.supervision.module&&($scope.supervision.poll=ModuleService.pollInstances($scope.supervision.module,function(promise){promise.success(function(data){angular.forEach(data,function(instance){var instanceName=instance.name;angular.forEach(instance.attrs,function(data,attr){var attrName=instanceName+"."+attr;$scope.supervision.data[attrName]||($scope.supervision.data[attrName]=[]);var attrData=$scope.supervision.data[attrName];attrData.push([instance.time,data]),$scope.supervision.maxData<attrData.length&&attrData.splice(0,attrData.length-$scope.supervision.maxData)})})}).error(function(){})}),$scope.$on("$routeChangeSuccess",function(){$scope.supervision.poll.cancel(),$scope.supervision.module="",$scope.supervision.data={},$scope.supervision.graphData=[]}))}),HouseMapService.getRooms().then(function(rooms){$scope.rooms=rooms}),$scope.map={},$scope.map.box={},$scope.map.points=function(room){var pointsRepr="";return angular.forEach(room.polygon,function(point,i){pointsRepr+=point.x+","+point.y,i<room.polygon.length-1&&(pointsRepr+=" ")}),pointsRepr},$scope.map.padding=function(){return $scope.map.paddingRatio*Math.max($scope.map.box.maxX-$scope.map.box.minX,$scope.map.box.maxY-$scope.map.box.minY)},$scope.map.paddingRatio=.05,$scope.$watch("rooms",function(){angular.forEach($scope.rooms,function(room){angular.forEach(room.polygon,function(point){void 0===$scope.map.box.minX||point.x<$scope.map.box.minX?$scope.map.box.minX=point.x:(void 0===$scope.map.box.maxX||point.x>$scope.map.box.maxX)&&($scope.map.box.maxX=point.x),void 0===$scope.map.box.minY||point.y<$scope.map.box.minY?$scope.map.box.minY=point.y:(void 0===$scope.map.box.maxY||point.y>$scope.map.box.maxY)&&($scope.map.box.maxY=point.y)})})})}function ModuleInjectorCtrl($scope,$route,$routeParams,$http,$compile){$route.current.templateUrl="/api/modules/"+$routeParams.moduleName+"/public/partial.html",$.get($route.current.templateUrl,function(data){$("#inject").html($compile(data)($scope))})}function ModulesCtrl($scope,$location,ModuleService){$scope.modules=[],$scope.reloadModules=function(){ModuleService.installed().then(function(modules){$scope.modules=modules})},$scope.reloadModules(),$scope.uninstall=function(module){console.log("uninstalling",module)},$scope.navigate=function(module){$location.path(module.has_view?"/modules/"+module.id:"/settings")}}function StoreCtrl($scope,$modal,ModuleService){$scope.modules=[],$scope.reloadModules=function(){ModuleService.available().then(function(modules){$scope.modules=modules})},$scope.reloadModules(),$scope.install=function(module){console.log("installing module",module)},$scope.uploading=!1,$scope.upload=function(file){$scope.uploading=!0,$scope.upload=ModuleService.install(file).progress(function(evt){$scope.uploadProgress=parseInt(100*evt.loaded/evt.total)}).success(function(){$scope.uploading=!1,$scope.reloadModules()}).error(function(){$scope.uploading=!1})},$scope.modalInstances={},$scope.openModal=function(module){var modalScope=$scope.$new(!0);modalScope.dismiss=function(){$scope.modalInstances[module.id].dismiss()},modalScope.install=function(){$scope.install(module),modalScope.dismiss()},modalScope.module=module,$scope.modalInstances[module.id]=$modal.open({templateUrl:"modal.html",scope:modalScope})}}function MainCtrl($scope,ModuleService,HouseMapService){$scope.supervision={},$scope.supervision.module="",$scope.supervision.data={},$scope.supervision.maxData=10,$scope.supervision.poll=null,$scope.$watch("supervision.module",function(){$scope.supervision.poll&&($scope.supervision.poll.cancel(),$scope.supervision.data={}),$scope.supervision.module&&($scope.supervision.poll=ModuleService.pollInstances($scope.supervision.module,function(promise){promise.success(function(data){angular.forEach(data,function(instance){var instanceName=instance.name;angular.forEach(instance.attrs,function(data,attr){var attrName=instanceName+"."+attr;$scope.supervision.data[attrName]||($scope.supervision.data[attrName]=[]);var attrData=$scope.supervision.data[attrName];attrData.push([instance.time,data]),$scope.supervision.maxData<attrData.length&&attrData.splice(0,attrData.length-$scope.supervision.maxData)})})}).error(function(){})}),$scope.$on("$routeChangeSuccess",function(){$scope.supervision.poll.cancel(),$scope.supervision.module="",$scope.supervision.data={},$scope.supervision.graphData=[]}))}),HouseMapService.getRooms().then(function(rooms){$scope.rooms=rooms}),$scope.map={},$scope.map.box={},$scope.map.points=function(room){var pointsRepr="";return angular.forEach(room.polygon,function(point,i){pointsRepr+=point.x+","+point.y,i<room.polygon.length-1&&(pointsRepr+=" ")}),pointsRepr},$scope.map.padding=function(){return $scope.map.paddingRatio*Math.max($scope.map.box.maxX-$scope.map.box.minX,$scope.map.box.maxY-$scope.map.box.minY)},$scope.map.paddingRatio=.05,$scope.$watch("rooms",function(){angular.forEach($scope.rooms,function(room){angular.forEach(room.polygon,function(point){void 0===$scope.map.box.minX||point.x<$scope.map.box.minX?$scope.map.box.minX=point.x:(void 0===$scope.map.box.maxX||point.x>$scope.map.box.maxX)&&($scope.map.box.maxX=point.x),void 0===$scope.map.box.minY||point.y<$scope.map.box.minY?$scope.map.box.minY=point.y:(void 0===$scope.map.box.maxY||point.y>$scope.map.box.maxY)&&($scope.map.box.maxY=point.y)})})})}function ModuleInjectorCtrl($scope,$route,$routeParams,$http,$compile){$route.current.templateUrl="/api/modules/"+$routeParams.moduleName+"/public/partial.html",$.get($route.current.templateUrl,function(data){$("#inject").html($compile(data)($scope))})}function ModulesCtrl($scope,$location,ModuleService){$scope.modules=[],$scope.reloadModules=function(){ModuleService.installed().then(function(modules){$scope.modules=modules})},$scope.reloadModules(),$scope.uninstall=function(module){console.log("uninstalling",module)},$scope.navigate=function(module){$location.path(module.has_view?"/modules/"+module.id:"/settings")}}function StoreCtrl($scope,$modal,ModuleService){$scope.modules=[],$scope.reloadModules=function(){ModuleService.available().then(function(modules){$scope.modules=modules})},$scope.reloadModules(),$scope.install=function(module){console.log("installing module",module)},$scope.uploading=!1,$scope.upload=function(file){$scope.uploading=!0,$scope.upload=ModuleService.install(file).progress(function(evt){$scope.uploadProgress=parseInt(100*evt.loaded/evt.total)}).success(function(){$scope.uploading=!1,$scope.reloadModules()}).error(function(){$scope.uploading=!1})},$scope.modalInstances={},$scope.openModal=function(module){var modalScope=$scope.$new(!0);modalScope.dismiss=function(){$scope.modalInstances[module.id].dismiss()},modalScope.install=function(){$scope.install(module),modalScope.dismiss()},modalScope.module=module,$scope.modalInstances[module.id]=$modal.open({templateUrl:"modal.html",scope:modalScope})}}function MainCtrl(a,b,c){a.supervision={},a.supervision.module="",a.supervision.data={},a.supervision.maxData=10,a.supervision.poll=null,a.$watch("supervision.module",function(){a.supervision.poll&&(a.supervision.poll.cancel(),a.supervision.data={}),a.supervision.module&&(a.supervision.poll=b.pollInstances(a.supervision.module,function(b){b.success(function(b){angular.forEach(b,function(b){var c=b.name;angular.forEach(b.attrs,function(d,e){var f=c+"."+e;a.supervision.data[f]||(a.supervision.data[f]=[]);var g=a.supervision.data[f];g.push([b.time,d]),a.supervision.maxData<g.length&&g.splice(0,g.length-a.supervision.maxData)})})}).error(function(){})}),a.$on("$routeChangeSuccess",function(){a.supervision.poll.cancel(),a.supervision.module="",a.supervision.data={},a.supervision.graphData=[]}))}),c.getRooms().then(function(b){a.rooms=b}),a.map={},a.map.box={},a.map.points=function(a){var b="";return angular.forEach(a.polygon,function(c,d){b+=c.x+","+c.y,d<a.polygon.length-1&&(b+=" ")}),b},a.map.padding=function(){return a.map.paddingRatio*Math.max(a.map.box.maxX-a.map.box.minX,a.map.box.maxY-a.map.box.minY)},a.map.paddingRatio=.05,a.$watch("rooms",function(){angular.forEach(a.rooms,function(b){angular.forEach(b.polygon,function(b){void 0===a.map.box.minX||b.x<a.map.box.minX?a.map.box.minX=b.x:(void 0===a.map.box.maxX||b.x>a.map.box.maxX)&&(a.map.box.maxX=b.x),void 0===a.map.box.minY||b.y<a.map.box.minY?a.map.box.minY=b.y:(void 0===a.map.box.maxY||b.y>a.map.box.maxY)&&(a.map.box.maxY=b.y)})})})}function ModuleInjectorCtrl(a,b,c,d,e){b.current.templateUrl="/api/modules/"+c.moduleName+"/public/partial.html",$.get(b.current.templateUrl,function(b){$("#inject").html(e(b)(a))})}function ModulesCtrl(a,b,c){a.modules=[],a.reloadModules=function(){c.installed().then(function(b){a.modules=b})},a.reloadModules(),a.uninstall=function(a){console.log("uninstalling",a)},a.navigate=function(a){b.path(a.has_view?"/modules/"+a.id:"/settings")}}function StoreCtrl(a,b,c){a.modules=[],a.reloadModules=function(){c.available().then(function(b){a.modules=b})},a.reloadModules(),a.install=function(a){console.log("installing module",a)},a.uploading=!1,a.upload=function(b){a.uploading=!0,a.upload=c.install(b).progress(function(b){a.uploadProgress=parseInt(100*b.loaded/b.total)}).success(function(){a.uploading=!1,a.reloadModules()}).error(function(){a.uploading=!1})},a.modalInstances={},a.openModal=function(c){var d=a.$new(!0);d.dismiss=function(){a.modalInstances[c.id].dismiss()},d.install=function(){a.install(c),d.dismiss()},d.module=c,a.modalInstances[c.id]=b.open({templateUrl:"modal.html",scope:d})}}angular.module("GHome").directive("graph",function(){return{restrict:"EA",link:function($scope,elem,attrs){var chart=null,opts={xaxis:{tickLength:0},yaxis:{tickLength:0},grid:{borderWidth:0,aboveData:!0,markings:[{yaxis:{from:0,to:0},color:"#888"},{xaxis:{from:0,to:0},color:"#888"}]},series:{shadowSize:0,points:{show:!0},lines:{show:!0}}};$scope.$watch(attrs.graphModel,function(data){var plottedData=[];data instanceof Array?plottedData=data:angular.forEach(data,function(rawData,label){plottedData.push({label:label,data:rawData})}),chart?(chart.setData(plottedData),chart.setupGrid(),chart.draw()):(chart=$.plot(elem,plottedData,opts),elem.css("display","block"))},!0)}}}),angular.module("GHome").directive("svgVbox",function(){return{link:function($scope,elem,attrs){var padding=0;attrs.$observe("svgVboxPadding",function(value){void 0!==value&&(value=parseFloat($scope.$eval(value)),padding=value)}),$scope.$watch(attrs.svgVbox,function(vbox){void 0===vbox.minX&&(vbox.minX=0),void 0===vbox.maxX&&(vbox.maxX=0),void 0===vbox.minY&&(vbox.minY=0),void 0===vbox.maxY&&(vbox.maxY=0);var x=vbox.minX-padding,y=vbox.minY-padding,w=vbox.maxX-vbox.minX+2*padding,h=vbox.maxY-vbox.minY+2*padding;elem[0].setAttribute("viewBox",x+" "+y+" "+w+" "+h)})}}}),angular.module("GHome",["ngRoute","ui.bootstrap","angularFileUpload"]).config(function($routeProvider,$locationProvider,$httpProvider){$routeProvider.when("/home",{templateUrl:"/partials/home.html"}).when("/store",{templateUrl:"/partials/store.html"}).when("/settings",{templateUrl:"/partials/settings.html"}).when("/modules",{templateUrl:"/partials/modules.html"}).when("/modules/:moduleName",{controller:"ModuleInjectorCtrl",templateUrl:"/partials/module_inject.html"}).otherwise({redirectTo:"/home"}),less.logLevel=1;var isFirstLoad=!0;$httpProvider.interceptors.push(function(){return{response:function(response){if(isFirstLoad)isFirstLoad=!1;else{var sheets=[],links=document.getElementsByTagName("link");angular.forEach(links,function(link){"stylesheet/less"==link.rel&&sheets.push(link)}),less.sheets.length!=sheets.length&&less.sheets!=sheets&&(less.sheets=sheets,less.refresh())}return response}}})}),angular.module("GHome").directive("graph",function(){return{restrict:"EA",link:function($scope,elem,attrs){var chart=null,opts={xaxis:{tickLength:0},yaxis:{tickLength:0},grid:{borderWidth:0,aboveData:!0,markings:[{yaxis:{from:0,to:0},color:"#888"},{xaxis:{from:0,to:0},color:"#888"}]},series:{shadowSize:0,points:{show:!0},lines:{show:!0}}};$scope.$watch(attrs.graphModel,function(data){var plottedData=[];data instanceof Array?plottedData=data:angular.forEach(data,function(rawData,label){plottedData.push({label:label,data:rawData})}),chart?(chart.setData(plottedData),chart.setupGrid(),chart.draw()):(chart=$.plot(elem,plottedData,opts),elem.css("display","block"))},!0)}}}),angular.module("GHome").directive("svgVbox",function(){return{link:function($scope,elem,attrs){var padding=0;attrs.$observe("svgVboxPadding",function(value){void 0!==value&&(value=parseFloat($scope.$eval(value)),padding=value)}),$scope.$watch(attrs.svgVbox,function(vbox){void 0===vbox.minX&&(vbox.minX=0),void 0===vbox.maxX&&(vbox.maxX=0),void 0===vbox.minY&&(vbox.minY=0),void 0===vbox.maxY&&(vbox.maxY=0);var x=vbox.minX-padding,y=vbox.minY-padding,w=vbox.maxX-vbox.minX+2*padding,h=vbox.maxY-vbox.minY+2*padding;elem[0].setAttribute("viewBox",x+" "+y+" "+w+" "+h)})}}}),angular.module("GHome").factory("HouseMapService",function($q,$timeout,$http){var service={};return service.getRooms=function(){var deferred=$q.defer();return $http.get("/api/rooms").success(function(rooms){deferred.resolve(rooms)}),deferred.promise},service}),angular.module("GHome").factory("ModuleService",function($q,$http,$timeout,$upload){var service={defaultPollingDelay:1e3},getModules=function(url,cachedModules,forceReload){var deferred=$q.defer();return forceReload?deferred.resolve(cachedModules):$http.get(url).success(function(data){cachedModules=data,deferred.resolve(data)}),deferred.promise};return service.availableModules=[],service.available=function(forceReload){return getModules("/api/available_modules",this.availableModules,forceReload)},service.installedModules=[],service.installed=function(forceReload){return getModules("/api/modules",this.installedModules,forceReload)},service.pollInstances=function(name,callback,delay){void 0===delay&&(delay=service.defaultPollingDelay);var timeout=$timeout(function pollFn(){callback($http.get("/api/modules/"+name+"/instances/status")),timeout=$timeout(pollFn,delay)},delay);return{cancel:function(){$timeout.cancel(timeout)}}},service.install=function(file){return $upload.upload({url:"/api/modules/install",method:"POST",file:file})},service}),angular.module("GHome").filter("truncate",function(){return function(text,length,end){return void 0!==text?(isNaN(length)&&(length=10),void 0===end&&(end="..."),text.length<=length||text.length-end.length<=length?text:String(text).substring(0,length-end.length)+end):void 0}}),angular.module("GHome",["ngRoute","ui.bootstrap","angularFileUpload"]).config(function(a,b,c){a.when("/home",{templateUrl:"/partials/home.html"}).when("/store",{templateUrl:"/partials/store.html"}).when("/settings",{templateUrl:"/partials/settings.html"}).when("/modules",{templateUrl:"/partials/modules.html"}).when("/modules/:moduleName",{controller:"ModuleInjectorCtrl",templateUrl:"/partials/module_inject.html"}).otherwise({redirectTo:"/home"}),less.logLevel=1;var d=!0;c.interceptors.push(function(){return{response:function(a){if(d)d=!1;else{var b=[],c=document.getElementsByTagName("link");angular.forEach(c,function(a){"stylesheet/less"==a.rel&&b.push(a)}),less.sheets.length!=b.length&&less.sheets!=b&&(less.sheets=b,less.refresh())}return a}}})}),angular.module("GHome").directive("graph",function(){return{restrict:"EA",link:function(a,b,c){var d=null,e={xaxis:{tickLength:0},yaxis:{tickLength:0},grid:{borderWidth:0,aboveData:!0,markings:[{yaxis:{from:0,to:0},color:"#888"},{xaxis:{from:0,to:0},color:"#888"}]},series:{shadowSize:0,points:{show:!0},lines:{show:!0}}};a.$watch(c.graphModel,function(a){var c=[];a instanceof Array?c=a:angular.forEach(a,function(a,b){c.push({label:b,data:a})}),d?(d.setData(c),d.setupGrid(),d.draw()):(d=$.plot(b,c,e),b.css("display","block"))},!0)}}}),angular.module("GHome").directive("svgVbox",function(){return{link:function(a,b,c){var d=0;c.$observe("svgVboxPadding",function(b){void 0!==b&&(b=parseFloat(a.$eval(b)),d=b)}),a.$watch(c.svgVbox,function(a){void 0===a.minX&&(a.minX=0),void 0===a.maxX&&(a.maxX=0),void 0===a.minY&&(a.minY=0),void 0===a.maxY&&(a.maxY=0);var c=a.minX-d,e=a.minY-d,f=a.maxX-a.minX+2*d,g=a.maxY-a.minY+2*d;b[0].setAttribute("viewBox",c+" "+e+" "+f+" "+g)})}}}),angular.module("GHome").factory("HouseMapService",function(a,b,c){var d={};return d.getRooms=function(){var b=a.defer();return c.get("/api/rooms").success(function(a){b.resolve(a)}),b.promise},d}),angular.module("GHome").factory("ModuleService",function(a,b,c,d){var e={defaultPollingDelay:1e3},f=function(c,d,e){var f=a.defer();return e?f.resolve(d):b.get(c).success(function(a){d=a,f.resolve(a)}),f.promise};return e.availableModules=[],e.available=function(a){return f("/api/available_modules",this.availableModules,a)},e.installedModules=[],e.installed=function(a){return f("/api/modules",this.installedModules,a)},e.pollInstances=function(a,d,f){void 0===f&&(f=e.defaultPollingDelay);var g=c(function h(){d(b.get("/api/modules/"+a+"/instances/status")),g=c(h,f)},f);return{cancel:function(){c.cancel(g)}}},e.install=function(a){return d.upload({url:"/api/modules/install",method:"POST",file:a})},e}),angular.module("GHome").filter("truncate",function(){return function(a,b,c){return void 0!==a?(isNaN(b)&&(b=10),void 0===c&&(c="..."),a.length<=b||a.length-c.length<=b?a:String(a).substring(0,b-c.length)+c):void 0}}),angular.module("GHome").filter("truncate",function(){return function(text,length,end){return void 0!==text?(isNaN(length)&&(length=10),void 0===end&&(end="..."),text.length<=length||text.length-end.length<=length?text:String(text).substring(0,length-end.length)+end):void 0}}),angular.module("GHome",["ngRoute","ui.bootstrap","angularFileUpload"]).config(function($routeProvider,$locationProvider,$httpProvider){$routeProvider.when("/home",{templateUrl:"/partials/home.html"}).when("/store",{templateUrl:"/partials/store.html"}).when("/settings",{templateUrl:"/partials/settings.html"}).when("/modules",{templateUrl:"/partials/modules.html"}).when("/modules/:moduleName",{controller:"ModuleInjectorCtrl",templateUrl:"/partials/module_inject.html"}).otherwise({redirectTo:"/home"}),less.logLevel=1;var isFirstLoad=!0;$httpProvider.interceptors.push(function(){return{response:function(response){if(isFirstLoad)isFirstLoad=!1;else{var sheets=[],links=document.getElementsByTagName("link");angular.forEach(links,function(link){"stylesheet/less"==link.rel&&sheets.push(link)}),less.sheets.length!=sheets.length&&less.sheets!=sheets&&(less.sheets=sheets,less.refresh())}return response}}})}),angular.module("GHome").factory("HouseMapService",function($q,$timeout,$http){var service={};return service.getRooms=function(){var deferred=$q.defer();return $http.get("/api/rooms").success(function(rooms){deferred.resolve(rooms)}),deferred.promise},service}),angular.module("GHome").factory("ModuleService",function($q,$http,$timeout,$upload){var service={defaultPollingDelay:1e3},getModules=function(url,cachedModules,forceReload){var deferred=$q.defer();return forceReload?deferred.resolve(cachedModules):$http.get(url).success(function(data){cachedModules=data,deferred.resolve(data)}),deferred.promise};return service.availableModules=[],service.available=function(forceReload){return getModules("/api/available_modules",this.availableModules,forceReload)},service.installedModules=[],service.installed=function(forceReload){return getModules("/api/modules",this.installedModules,forceReload)},service.pollInstances=function(name,callback,delay){void 0===delay&&(delay=service.defaultPollingDelay);var timeout=$timeout(function pollFn(){callback($http.get("/api/modules/"+name+"/instances/status")),timeout=$timeout(pollFn,delay)},delay);return{cancel:function(){$timeout.cancel(timeout)}}},service.install=function(file){return $upload.upload({url:"/api/modules/install",method:"POST",file:file})},service});